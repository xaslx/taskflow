<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .auth-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .block {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .user-management {
            grid-column: 1 / -1;
        }

        .admin-management {
            grid-column: 1 / -1;
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .block h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .admin-management h2 {
            color: #92400e;
        }

        .user-info {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .user-info p {
            margin: 8px 0;
            color: #4b5563;
        }

        .user-info strong {
            color: #1f2937;
        }

        .actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .auth-form {
            background: #f8fafc;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .admin-form {
            background: #fffbeb;
            border: 1px solid #fcd34d;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .hidden {
            display: none;
        }

        .user-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .password-requirements {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        .password-requirements ul {
            margin-left: 20px;
        }

        .teams-list {
            margin-top: 20px;
        }

        .team-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .team-name {
            font-weight: bold;
            color: #1f2937;
        }

        .team-code {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
        }

        .team-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">User Management System</div>
            <div class="auth-section" id="authSection">
                {% if user %}
                    <span>{{ user.email }} ({{ user.role }})</span>
                    <button class="btn btn-secondary" onclick="userManager.logout()">Выход</button>
                {% else %}
                    <button class="btn btn-primary" onclick="userManager.showForm('login')">Вход</button>
                    <button class="btn btn-secondary" onclick="userManager.showForm('register')">Регистрация</button>
                {% endif %}
            </div>
        </header>

        <main class="main-content">

            <div class="block user-management">
                <h2>User Management</h2>
                <div id="userInfo">
                    {% if user %}
                        <div class="user-info">
                            <h3>Информация о пользователе</h3>
                            <div class="user-details">
                                <p><strong>ID:</strong> {{ user.id }}</p>
                                <p><strong>Email:</strong> {{ user.email }}</p>
                                <p><strong>Роль:</strong> {{ user.role }}</p>
                                <p><strong>Создан:</strong> {{ user.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
                                {% if user.team_id %}
                                <p><strong>Команда ID:</strong> {{ user.team_id }}</p>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="user-info">
                            <p>Пожалуйста, войдите в систему или зарегистрируйтесь</p>
                        </div>
                    {% endif %}
                </div>
                <div class="actions" id="userActions">
                    {% if user %}
                        <button class="btn btn-primary" onclick="userManager.refreshToken()">Refresh Token</button>
                        
                        <button class="btn btn-secondary" onclick="userManager.showForm('update')">Обновить данные</button>
                        <button class="btn btn-danger" onclick="userManager.deleteAccount()">Удалить аккаунт</button>
                        {% if not user.team_id %}
                        <button class="btn btn-success" onclick="userManager.showForm('joinTeam')">Присоединиться к команде</button>
                        {% endif %}
                    {% endif %}
                
                </div>
                Время жизни access token'a 10 минут 
                <div id="authForms">

                </div>
                <div id="message" class="message hidden"></div>
            </div>


            {% if user and user.role == 'admin' %}
            <div class="block admin-management">
                <h2>Admin Management</h2>
                
                <div class="actions">
                    <button class="btn btn-warning" onclick="userManager.showForm('adminDelete')">Удалить пользователя</button>
                    <button class="btn btn-success" onclick="userManager.showForm('createTeam')">Создать команду</button>
                    <button class="btn btn-primary" onclick="userManager.loadTeams()">Загрузить список команд</button>
                </div>


                <div id="teamsList" class="teams-list hidden">
                    <h3>Список команд</h3>
                    <div id="teamsContainer"></div>
                </div>

                <div id="adminForms">

                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <script>
        class UserManager {
            constructor() {
                this.baseUrl = '/api/auth';
                this.usersUrl = '/api/users';
                this.teamsUrl = '/api/teams';
                this.init();
            }

            async init() {
                this.renderAuthForms();
                this.renderAdminForms();
                this.setupEventListeners();
            }

            async makeRequest(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers,
                        },
                        credentials: 'include',
                        ...options,
                    });

                    console.log('Response status:', response.status);

                    if (response.status === 204) {
                        return null;
                    }

                    if (!response.ok && response.status !== 422) {
                        let errorDetail = 'Ошибка запроса';
                        try {
                            const errorData = await response.json();
                            errorDetail = errorData.detail || errorDetail;
                        } catch (e) {
                            errorDetail = `HTTP ${response.status}: ${response.statusText}`;
                        }
                        throw new Error(errorDetail);
                    }

                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    if (!response.ok) {
                        if (response.status === 422 && data.detail) {
                            const validationErrors = Array.isArray(data.detail) 
                                ? data.detail.map(err => err.msg).join(', ')
                                : data.detail;
                            throw new Error(`Ошибка валидации: ${validationErrors}`);
                        }
                        throw new Error(data.detail || 'Ошибка запроса');
                    }

                    return data;
                } catch (error) {
                    this.showMessage(error.message, 'error');
                    throw error;
                }
            }

            renderAuthForms() {
                const authForms = document.getElementById('authForms');
                
                authForms.innerHTML = `
                    <div id="loginForm" class="auth-form hidden">
                        <h3>Вход в систему</h3>
                        <form onsubmit="event.preventDefault(); userManager.login()">
                            <div class="form-group">
                                <label for="loginEmail">Email:</label>
                                <input type="email" id="loginEmail" required placeholder="user@example.com">
                            </div>
                            <div class="form-group">
                                <label for="loginPassword">Пароль:</label>
                                <input type="password" id="loginPassword" required placeholder="Введите пароль">
                            </div>
                            <button type="submit" class="btn btn-primary">Войти</button>
                            <button type="button" class="btn btn-secondary" onclick="userManager.hideForms()">Отмена</button>
                        </form>
                    </div>

                    <div id="registerForm" class="auth-form hidden">
                        <h3>Регистрация</h3>
                        <form onsubmit="event.preventDefault(); userManager.register()">
                            <div class="form-group">
                                <label for="registerEmail">Email:</label>
                                <input type="email" id="registerEmail" required placeholder="user@example.com">
                            </div>
                            <div class="form-group">
                                <label for="registerPassword">Пароль:</label>
                                <input type="password" id="registerPassword" required placeholder="Придумайте пароль">
                                <div class="password-requirements">
                                    <strong>Требования к паролю:</strong>
                                    <ul>
                                        <li>Длина от 6 до 20 символов</li>
                                        <li>Только латинские буквы, цифры и специальные символы</li>
                                        <li>Минимум одна буква</li>
                                        <li>Минимум одна цифра</li>
                                    </ul>
                                    <p><strong>Пример:</strong> Test123, password1, 12345Abc</p>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
                            <button type="button" class="btn btn-secondary" onclick="userManager.hideForms()">Отмена</button>
                        </form>
                    </div>

                    <div id="updateForm" class="auth-form hidden">
                        <h3>Обновление данных</h3>
                        <form onsubmit="event.preventDefault(); userManager.updateUser()">
                            <div class="form-group">
                                <label for="updateEmail">Новый Email:</label>
                                <input type="email" id="updateEmail" placeholder="Новый email">
                            </div>
                            <div class="form-group">
                                <label for="updatePassword">Новый Пароль:</label>
                                <input type="password" id="updatePassword" placeholder="Новый пароль">
                            </div>
                            <button type="submit" class="btn btn-primary">Обновить</button>
                            <button type="button" class="btn btn-secondary" onclick="userManager.hideForms()">Отмена</button>
                        </form>
                    </div>

                    <div id="joinTeamForm" class="auth-form hidden">
                        <h3>Присоединение к команде</h3>
                        <form onsubmit="event.preventDefault(); userManager.joinTeam()">
                            <div class="form-group">
                                <label for="joinTeamCode">Код команды:</label>
                                <input type="text" id="joinTeamCode" required placeholder="Введите код команды">
                            </div>
                            <button type="submit" class="btn btn-success">Присоединиться</button>
                            <button type="button" class="btn btn-secondary" onclick="userManager.hideForms()">Отмена</button>
                        </form>
                    </div>
                `;
            }

            renderAdminForms() {
                const adminForms = document.getElementById('adminForms');
                if (adminForms) {
                    adminForms.innerHTML = `
                        <div id="adminDeleteForm" class="auth-form admin-form hidden">
                            <h3>Удаление пользователя (Admin)</h3>
                            <form onsubmit="event.preventDefault(); userManager.adminDeleteUser()">
                                <div class="form-group">
                                    <label for="adminDeleteUserId">ID пользователя:</label>
                                    <input type="number" id="adminDeleteUserId" required placeholder="Введите ID пользователя">
                                </div>
                                <button type="submit" class="btn btn-danger">Удалить пользователя</button>
                                <button type="button" class="btn btn-secondary" onclick="userManager.hideAdminForms()">Отмена</button>
                            </form>
                        </div>

                        <div id="createTeamForm" class="auth-form admin-form hidden">
                            <h3>Создание команды (Admin)</h3>
                            <form onsubmit="event.preventDefault(); userManager.createTeam()">
                                <div class="form-group">
                                    <label for="teamName">Название команды:</label>
                                    <input type="text" id="teamName" required placeholder="Введите название команды">
                                </div>
                                <div class="form-group">
                                    <label for="teamDescription">Описание команды:</label>
                                    <input type="text" id="teamDescription" placeholder="Введите описание команды">
                                </div>
                                <button type="submit" class="btn btn-success">Создать команду</button>
                                <button type="button" class="btn btn-secondary" onclick="userManager.hideAdminForms()">Отмена</button>
                            </form>
                        </div>
                    `;
                }
            }

            showForm(formType) {
                this.hideForms();
                this.hideAdminForms();
                const form = document.getElementById(`${formType}Form`);
                if (form) {
                    form.classList.remove('hidden');
                }
            }

            hideForms() {
                document.querySelectorAll('.auth-form').forEach(form => {
                    form.classList.add('hidden');
                });
            }

            hideAdminForms() {
                document.querySelectorAll('.admin-form').forEach(form => {
                    form.classList.add('hidden');
                });
            }

            async login() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    const data = await this.makeRequest(`${this.baseUrl}/login`, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            email: email, 
                            password: password 
                        }),
                    });

                    this.showMessage('Успешный вход! Перезагружаем страницу...', 'success');
                    this.hideForms();
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                    
                } catch (error) {
                    console.error('Login error:', error);
                }
            }

            async register() {
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;

                try {
                    const data = await this.makeRequest(`${this.baseUrl}/register`, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            email: email, 
                            password: password 
                        }),
                    });

                    this.showMessage('Регистрация успешна! Теперь вы можете войти.', 'success');
                    this.hideForms();
                    
                } catch (error) {
                    console.error('Register error:', error);
                }
            }

            async logout() {
                try {
                    await this.makeRequest(`${this.baseUrl}/logout`, {
                        method: 'POST',
                    });

                    this.showMessage('Вы успешно вышли из системы', 'success');
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }

            async refreshToken() {
                try {
                    const data = await this.makeRequest(`${this.baseUrl}/refresh-token`, {
                        method: 'POST',
                    });

                    this.showMessage('Token успешно обновлён!', 'success');
                } catch (error) {
                    console.error('Refresh token error:', error);
                }
            }

            async updateUser() {
                const email = document.getElementById('updateEmail').value;
                const password = document.getElementById('updatePassword').value;

                try {
                    const updateData = {};
                    if (email) updateData.email = email;
                    if (password) updateData.password = password;

                    const data = await this.makeRequest(`${this.usersUrl}/`, {
                        method: 'PATCH',
                        body: JSON.stringify(updateData),
                    });

                    this.showMessage('Данные успешно обновлены!', 'success');
                    this.hideForms();
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Update user error:', error);
                }
            }

            async deleteAccount() {
                if (confirm('Вы уверены, что хотите удалить аккаунт? Это действие нельзя отменить.')) {
                    try {
                        await this.makeRequest(`${this.usersUrl}/`, {
                            method: 'DELETE',
                        });

                        this.showMessage('Аккаунт успешно удалён!', 'success');
                        
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                        
                    } catch (error) {
                        console.error('Delete account error:', error);
                    }
                }
            }

            async joinTeam() {
                const code = document.getElementById('joinTeamCode').value;

                try {
                    const data = await this.makeRequest(`${this.teamsUrl}/join`, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            code: code
                        }),
                    });

                    this.showMessage('Успешно присоединились к команде!', 'success');
                    this.hideForms();
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Join team error:', error);
                }
            }

            async createTeam() {
                const name = document.getElementById('teamName').value;
                const description = document.getElementById('teamDescription').value;

                try {
                    const teamData = {
                        name: name
                    };
                    if (description) teamData.description = description;

                    const data = await this.makeRequest(`${this.teamsUrl}/`, {
                        method: 'POST',
                        body: JSON.stringify(teamData),
                    });

                    this.showMessage(`Команда "${data.name}" успешно создана! Код: ${data.code}`, 'success');
                    this.hideAdminForms();
                    
                    document.getElementById('teamName').value = '';
                    document.getElementById('teamDescription').value = '';
                    
                } catch (error) {
                    console.error('Create team error:', error);
                }
            }

            async loadTeams() {
                try {
                    const data = await this.makeRequest(`${this.teamsUrl}/`);
                    
                    const teamsList = document.getElementById('teamsList');
                    const teamsContainer = document.getElementById('teamsContainer');
                    
                    teamsList.classList.remove('hidden');
                    
                    if (data.items && data.items.length > 0) {
                        teamsContainer.innerHTML = data.items.map(team => `
                            <div class="team-item">
                                <div class="team-header">
                                    <span class="team-name">${team.name}</span>
                                    <span class="team-code">${team.code}</span>
                                </div>
                                <div class="team-details">
                                    <div><strong>ID:</strong> ${team.id}</div>
                                    <div><strong>Создана:</strong> ${new Date(team.created_at).toLocaleDateString()}</div>
                                    ${team.description ? `<div><strong>Описание:</strong> ${team.description}</div>` : ''}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        teamsContainer.innerHTML = '<p>Нет созданных команд</p>';
                    }
                    
                } catch (error) {
                    console.error('Load teams error:', error);
                }
            }

            async adminDeleteUser() {
                const userId = document.getElementById('adminDeleteUserId').value;

                if (!userId) {
                    this.showMessage('Введите ID пользователя', 'error');
                    return;
                }

                if (confirm(`Вы уверены, что хотите удалить пользователя с ID ${userId}?`)) {
                    try {
                        await this.makeRequest(`${this.usersUrl}/admin/${userId}`, {
                            method: 'DELETE',
                        });

                        this.showMessage(`Пользователь с ID ${userId} успешно удалён!`, 'success');
                        this.hideAdminForms();
                        document.getElementById('adminDeleteUserId').value = '';
                        
                    } catch (error) {
                        console.error('Admin delete user error:', error);
                    }
                }
            }

            showMessage(text, type) {
                const messageEl = document.getElementById('message');
                messageEl.textContent = text;
                messageEl.className = `message ${type}`;
                messageEl.classList.remove('hidden');

                setTimeout(() => {
                    messageEl.classList.add('hidden');
                }, 5000);
            }

            setupEventListeners() {
            }
        }

        const userManager = new UserManager();
    </script>
</body>
</html>